{% extends "base.html" %}

{% block title %}Track Your Pro - Bybytoo{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<section class="section-b-space">
    <div class="custom-container">
        <div class="title">
            <h2>Track Your Service</h2>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Booking #{{ booking.id }}</h5>
                <p class="card-text">Service: {{ booking.service.name }}</p>
                <p class="card-text">Status: <span id="status-badge" class="badge bg-primary">{{ booking.tracking_status
                        or 'Pending' }}</span></p>
                {% if booking.serviceman %}
                <p class="card-text">Pro: {{ booking.serviceman.name }}</p>
                {% else %}
                <p class="card-text text-warning">Waiting for provider assignment...</p>
                {% endif %}
            </div>
        </div>

        <div id="map"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    var map = L.map('map').setView([51.505, -0.09], 13); // Default view

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var marker = L.marker([51.505, -0.09]).addTo(map);
    var bookingId = {{ booking.id }};

    function updateLocation() {
        fetch(`/tracking/api/get_location/${bookingId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'error') {
                    var newLatLng = new L.LatLng(data.lat, data.lng);
                    marker.setLatLng(newLatLng);
                    map.panTo(newLatLng);
                    if (data.status) {
                        document.getElementById('status-badge').innerText = data.status;
                    }
                }
            })
            .catch(error => console.error('Error fetching location:', error));
    }

    // Poll every 5 seconds
    setInterval(updateLocation, 5000);

    // Initial call
    updateLocation();
</script>
{% endblock %}