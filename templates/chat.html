{% extends "base.html" %}

{% block title %}Chat - Bybytoo{% endblock %}

{% block styles %}
<style>
    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        background: #f9f9f9;
    }

    .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
    }

    .message.user {
        background: #e3f2fd;
        margin-left: auto;
    }

    .message.provider {
        background: #fff;
        border: 1px solid #eee;
    }

    .price-proposal {
        font-weight: bold;
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<section class="section-b-space">
    <div class="custom-container">
        <div class="title">
            <h2>Chat with {{ booking.serviceman.name if booking.serviceman else 'Provider' }}</h2>
        </div>

        <div class="chat-box mb-3" id="chat-box">
            {% for msg in messages %}
            <div class="message {{ msg.sender_type }}">
                <p>{{ msg.message }}</p>
                {% if msg.price_proposal %}
                <p class="price-proposal">Proposed Price: ${{ msg.price_proposal }}</p>
                {% endif %}
                <small class="text-muted">{{ msg.created_at.strftime('%H:%M') }}</small>
            </div>
            {% endfor %}
        </div>

        <form id="chat-form">
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="message-input" placeholder="Type a message..." required>
                <button class="btn btn-outline-secondary" type="button" id="suggest-price-btn">Suggest Price</button>
                <button class="btn theme-btn" type="submit">Send</button>
            </div>
            <div class="input-group mb-3" id="price-input-group" style="display: none;">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="price-input" placeholder="Enter price proposal">
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const priceInputGroup = document.getElementById('price-input-group');
    const priceInput = document.getElementById('price-input');
    const suggestPriceBtn = document.getElementById('suggest-price-btn');
    const bookingId = {{ booking.id }};

    // Scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;

    suggestPriceBtn.addEventListener('click', () => {
        // Toggle price input
        if (priceInputGroup.style.display === 'none') {
            priceInputGroup.style.display = 'flex';
            // Dummy suggestion logic
            const suggested = Math.floor(Math.random() * (100 - 50 + 1)) + 50;
            priceInput.value = suggested;
            messageInput.value = `I propose a price of $${suggested}.`;
        } else {
            priceInputGroup.style.display = 'none';
            priceInput.value = '';
        }
    });

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value;
        const price = priceInput.value ? parseFloat(priceInput.value) : null;

        fetch('/chat/api/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId,
                message: message,
                price_proposal: price
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message user'; // Assuming current user sent it
                    let html = `<p>${data.message.text}</p>`;
                    if (data.message.price) {
                        html += `<p class="price-proposal">Proposed Price: $${data.message.price}</p>`;
                    }
                    html += `<small class="text-muted">${data.message.created_at}</small>`;
                    msgDiv.innerHTML = html;
                    chatBox.appendChild(msgDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    messageInput.value = '';
                    priceInput.value = '';
                    priceInputGroup.style.display = 'none';
                }
            });
    });
</script>
{% endblock %}